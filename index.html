<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>PIPS Pro‚Ñ¢ ¬∑ Property Inspection Profit System (Phase 1)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* (Same styles as before ‚Äì keep them) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        body {
            background: #f0f4f8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        #app {
            max-width: 480px;
            width: 100%;
            background: white;
            border-radius: 36px 36px 24px 24px;
            box-shadow: 0 20px 40px rgba(0, 31, 63, 0.25);
            overflow: hidden;
            border: 1px solid rgba(255,215,0,0.3);
            position: relative;
            background-image: linear-gradient(145deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.98) 100%),
                              url('https://images.unsplash.com/photo-1514924013411-cbf25faa35bb?w=800');
            background-size: cover;
            background-blend-mode: overlay;
        }
        .header {
            background: rgba(11, 28, 63, 0.95);
            color: white;
            padding: 20px 20px 12px;
            backdrop-filter: blur(2px);
            border-bottom: 3px solid #FFD700;
        }
        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }
        .header h1 span {
            color: #FFD700;
            font-weight: 300;
            font-size: 1rem;
            display: block;
        }
        .header .byline {
            font-size: 0.85rem;
            color: #b0c4de;
            margin-top: 4px;
            border-left: 3px solid #FFD700;
            padding-left: 10px;
        }
        .screen-container {
            padding: 20px 16px 80px;
            min-height: 500px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(4px);
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: rgba(11, 28, 63, 0.98);
            padding: 8px 4px 12px;
            border-top: 2px solid #FFD700;
            position: sticky;
            bottom: 0;
            width: 100%;
        }
        .nav-item {
            color: #a0b9d4;
            text-align: center;
            font-size: 0.7rem;
            transition: all 0.1s;
            flex: 1;
            padding: 6px 0;
            border-radius: 20px;
            cursor: pointer;
        }
        .nav-item i {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 2px;
            color: #a0b9d4;
        }
        .nav-item.active {
            color: #FFD700;
            background: rgba(255,215,0,0.1);
        }
        .nav-item.active i {
            color: #FFD700;
        }
        .btn {
            background: #0B1C3F;
            border: none;
            color: white;
            padding: 14px 18px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin: 8px 0;
            border: 1px solid #FFD700;
            box-shadow: 0 4px 6px rgba(0,31,63,0.3);
            cursor: pointer;
        }
        .btn-secondary {
            background: #7C9EB2;
            border-color: #0B1C3F;
        }
        .btn-gold {
            background: #FFD700;
            color: #0B1C3F;
            border: 1px solid #0B1C3F;
        }
        .card {
            background: white;
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 10px rgba(0,31,63,0.1);
            border-left: 6px solid #FFD700;
        }
        input, textarea, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #7C9EB2;
            border-radius: 40px;
            font-size: 1rem;
            margin: 8px 0;
            background: rgba(255,255,255,0.9);
        }
        label {
            font-weight: 600;
            color: #0B1C3F;
            margin-left: 8px;
        }
        .protocol-item {
            background: rgba(124,158,178,0.1);
            border-radius: 20px;
            padding: 12px 16px;
            margin: 6px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #7C9EB2;
            cursor: pointer;
        }
        .protocol-item.free {
            border-left: 6px solid #FFD700;
        }
        .protocol-item.locked {
            opacity: 0.75;
            background: #e0e7ed;
        }
        .protocol-badge {
            background: #FFD700;
            color: #0B1C3F;
            border-radius: 40px;
            padding: 4px 12px;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .tier-badge {
            background: #0B1C3F;
            color: #FFD700;
            border-radius: 20px;
            padding: 2px 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-right: 8px;
        }
        .photo-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .photo-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #FFD700;
            position: relative;
        }
        .photo-thumb-container {
            position: relative;
            display: inline-block;
        }
        .annotate-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(11,28,63,0.8);
            color: #FFD700;
            font-size: 0.5rem;
            text-align: center;
            border-radius: 0 0 12px 12px;
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: 0.2s;
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background: white;
            max-width: 90%;
            width: 400px;
            padding: 20px;
            border-radius: 48px;
            border: 4px solid #FFD700;
            max-height: 80vh;
            overflow-y: auto;
        }
        .annotation-modal {
            width: 90%;
            max-width: 800px;
            background: #222;
        }
        #annotation-canvas {
            width: 100%;
            background: #333;
            border: 2px solid #FFD700;
            border-radius: 16px;
            cursor: crosshair;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        .tool-btn {
            background: #0B1C3F;
            color: #FFD700;
            border: 1px solid #FFD700;
            padding: 8px 16px;
            border-radius: 40px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .tool-btn.active {
            background: #FFD700;
            color: #0B1C3F;
        }
        .dimension-rating {
            background: #f0f4fa;
            border-radius: 16px;
            padding: 12px;
            margin: 12px 0;
        }
        .rating-item {
            display: flex;
            flex-direction: column;
            margin: 12px 0;
            padding: 10px;
            background: white;
            border-radius: 16px;
            border: 1px solid #7C9EB2;
        }
        .rating-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .rating-item-header input {
            width: 70px;
            padding: 8px;
            border-radius: 20px;
        }
        .item-photos {
            margin-top: 10px;
            padding: 10px;
            background: #eef3f7;
            border-radius: 12px;
        }
        .add-photo-btn {
            background: #7C9EB2;
            color: white;
            border: none;
            border-radius: 30px;
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
        }
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 500px;
        }
    </style>
</head>
<body>
<div id="app">
    <div class="header">
        <h1>PIPS Pro‚Ñ¢ <span>Property Inspection Profit System</span></h1>
        <div class="byline">By Ali Sekhr ¬∑ London‚ÄìDubai</div>
    </div>

    <div class="screen-container" id="screenContainer">
        <!-- LOGIN SCREEN -->
        <div id="login-screen" class="screen active">
            <div class="card" style="background: rgba(255,255,255,0.8);">
                <h2 style="color:#0B1C3F; margin-bottom:20px;"><i class="fas fa-clipboard-check" style="color:#FFD700;"></i> Inspect with PIPS</h2>
                <input type="email" id="login-email" placeholder="Email" value="demo@example.com">
                <input type="password" id="login-password" placeholder="Password" value="password">
                <button class="btn" id="login-btn"><i class="fas fa-sign-in-alt"></i> Log In</button>
                <p style="text-align:center; margin:10px;">or</p>
                <button class="btn btn-secondary" id="register-btn"><i class="fas fa-user-plus"></i> Register</button>
                <p style="font-size:0.8rem; margin-top:20px;">Demo: any email/password (localStorage)</p>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard-screen" class="screen">
            <div class="card">
                <h3>Welcome back, <span id="user-name">Inspector</span> üëã</h3>
                <p style="color:#0B1C3F;"><i class="fas fa-chart-line" style="color:#FFD700;"></i> This month: <span id="month-count">0</span> inspections</p>
            </div>
            <div class="card">
                <h4>Quick actions</h4>
                <button class="btn btn-gold" id="quick-new"><i class="fas fa-camera"></i> New Inspection</button>
                <button class="btn btn-secondary" id="quick-reports"><i class="fas fa-file-pdf"></i> Recent Reports</button>
            </div>
            <div class="card">
                <h4>Recent inspections</h4>
                <ul id="recent-list" style="list-style:none;">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>

        <!-- PROTOCOLS LIBRARY -->
        <div id="protocols-screen" class="screen">
            <div id="protocols-list-view">
                <h3 style="color:#0B1C3F;">üìã Protocol Library</h3>
                <p style="font-size:0.9rem;">First 3 free ¬∑ <i class="fas fa-crown" style="color:#FFD700;"></i> Upgrade to Pro for full access</p>
                <div id="protocol-list" class="protocol-list"></div>
            </div>
            <div id="protocol-detail-view" style="display: none;">
                <button class="back-btn" id="back-to-protocols"><i class="fas fa-arrow-left"></i> Back to library</button>
                <div id="protocol-detail-content"></div>
            </div>
        </div>

        <!-- NEW INSPECTION (with per‚Äëitem photos) -->
        <div id="new-inspection-screen" class="screen">
            <h3 style="color:#0B1C3F;">üè† New Inspection</h3>
            <div class="card">
                <label>Property address</label>
                <input type="text" id="prop-address" placeholder="e.g., 123 Main St">
                <label>Property type</label>
                <select id="prop-type">
                    <option>House</option>
                    <option>Apartment</option>
                    <option>Commercial</option>
                </select>
                <label>Size (sq ft)</label>
                <input type="number" id="prop-size" placeholder="2000">
                <label>Age (years)</label>
                <input type="number" id="prop-age" placeholder="15">
                <label>Select protocol</label>
                <select id="inspection-protocol"></select>
                
                <!-- Rating section with per‚Äëitem photos -->
                <div id="rating-section" style="margin-top: 20px;"></div>

                <button class="btn btn-gold" id="generate-report-btn"><i class="fas fa-file-pdf"></i> Generate Report & Save</button>
            </div>
        </div>

        <!-- REPORTS -->
        <div id="reports-screen" class="screen">
            <h3 style="color:#0B1C3F;">üìÅ Inspection Reports</h3>
            <div id="reports-list"></div>
        </div>

        <!-- PROFILE -->
        <div id="profile-screen" class="screen">
            <div class="card">
                <h4><i class="fas fa-user-circle"></i> Inspector Profile</h4>
                <p><strong>Email:</strong> <span id="profile-email"></span></p>
                <p><strong>Subscription Tier:</strong> <span id="sub-tier">Freemium (3 protocols)</span></p>
                <p><small>Upgrades coming soon ‚Äì stay tuned!</small></p>
                <button class="btn btn-secondary" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Log out</button>
            </div>
            <div class="card">
                <p style="text-align:center;">üöÄ ‚ÄúProperty Inspection Profit System‚Ñ¢‚Äù<br>By Ali Sekhr</p>
            </div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav" id="bottom-nav" style="display: none;">
        <div class="nav-item" data-screen="dashboard"><i class="fas fa-home"></i>Home</div>
        <div class="nav-item" data-screen="protocols"><i class="fas fa-book"></i>Protocols</div>
        <div class="nav-item" data-screen="new-inspection"><i class="fas fa-plus-circle"></i>New</div>
        <div class="nav-item" data-screen="reports"><i class="fas fa-file-alt"></i>Reports</div>
        <div class="nav-item" data-screen="profile"><i class="fas fa-user"></i>Profile</div>
    </div>
</div>

<!-- UPGRADE MODAL -->
<div id="upgrade-modal" class="modal">
    <div class="modal-content">
        <h3 style="color:#0B1C3F;">üîí Protocol Locked</h3>
        <p>This protocol is available in Pro tier. Upgrade to access all 38 protocols.</p>
        <button class="btn btn-gold" id="modal-upgrade">Upgrade (coming soon)</button>
        <button class="btn" id="modal-close">Close</button>
    </div>
</div>

<!-- ANNOTATION MODAL -->
<div id="annotation-modal" class="modal">
    <div class="modal-content annotation-modal" style="background:#2d2d2d; color:white;">
        <h3 style="color:#FFD700;">Annotate Photo</h3>
        <canvas id="annotation-canvas" width="400" height="300"></canvas>
        <div class="toolbar">
            <button class="tool-btn" id="tool-rect">Rectangle</button>
            <button class="tool-btn" id="tool-circle">Circle</button>
            <button class="tool-btn" id="tool-text">Text</button>
            <button class="tool-btn" id="tool-save">Save & Close</button>
            <button class="tool-btn" id="tool-cancel">Cancel</button>
        </div>
        <p style="font-size:0.8rem; margin-top:8px;">Rect: red, Circle: blue, Text: white. Click to draw.</p>
    </div>
</div>

<script>
(function() {
    // ==================== CONFIG ====================
    const API_BASE = 'https://your-backend.com/api';  // Replace with your Phase 1 backend URL
    const USE_REAL_API = false; // Set to true when backend is ready

    // ==================== MOCK PROTOCOLS (shortened for demo ‚Äì replace with full 38) ====================
    const protocolsData = [
        { id: 1, tier: 'T1', code: 'P01', name: 'Strategic Assessment Protocol', description: 'Strategic property assessment', weight: '2.0', free: true, dimensions: [
            { name: 'Location Analysis', items: ['Transport Links', 'Local Amenities', 'Employment Hubs'], redFlags: ['High crime area'] },
            { name: 'Market Positioning', items: ['Price Point', 'Target Demographic'], redFlags: ['Overpriced'] }
        ]},
        { id: 2, tier: 'T1', code: 'P02', name: 'Foundation Assessment Protocol', description: 'Foundation integrity', weight: '2.0', free: true, dimensions: [
            { name: 'Foundation Type', items: ['Type identified', 'Construction quality'], redFlags: ['Cracks >5mm'] }
        ]},
        { id: 3, tier: 'T1', code: 'P03', name: 'Structural Movement', description: 'Subsidence risks', weight: '2.0', free: true, dimensions: [] },
        { id: 4, tier: 'T1', code: 'P04', name: 'Environmental Hazards', description: 'Contamination', weight: '2.0', free: false, dimensions: [] },
        // ... add more protocols as needed
    ];
    const protocols = protocolsData.map(p => ({ ...p, free: p.free }));

    // LocalStorage keys
    const STORAGE_USER = 'pips_user';
    const STORAGE_INSPECTIONS = 'pips_inspections';
    const STORAGE_TOKEN = 'pips_token';

    let currentUser = null;
    let inspections = [];
    let authToken = localStorage.getItem(STORAGE_TOKEN);

    function loadLocalData() {
        const userJson = localStorage.getItem(STORAGE_USER);
        if (userJson) currentUser = JSON.parse(userJson);
        const inspJson = localStorage.getItem(STORAGE_INSPECTIONS);
        inspections = inspJson ? JSON.parse(inspJson) : [];
    }
    function saveLocalData() {
        localStorage.setItem(STORAGE_USER, JSON.stringify(currentUser));
        localStorage.setItem(STORAGE_INSPECTIONS, JSON.stringify(inspections));
    }

    loadLocalData();

    // ==================== API CLIENT STUB ====================
    const api = {
        async login(email, password) { /* same as before */ },
        async register(email, password) { /* same */ },
        async getProtocols() { return protocols; },
        async createAssessment(data) {
            const newId = inspections.length + 1;
            const assessment = { id: newId, ...data, userId: currentUser.id, status: 'in_progress', createdAt: new Date() };
            inspections.push(assessment);
            saveLocalData();
            return assessment;
        },
        async saveRating(data) { console.log('Saved rating (local)', data); },
        async getAssessment(id) { return inspections.find(a => a.id === id); },
        async getPhotoUploadUrl() { return { url: '#', key: 'mock' }; },
        async confirmPhotoUpload() { console.log('Photo confirmed'); }
    };

    // ==================== UI STATE ====================
    let currentAssessmentId = null; // will be set when creating
    let currentItemPhotos = {}; // key: `${dimIdx}_${itemIdx}`, value: array of photo objects { dataURL, annotatedDataURL, s3Key }

    // ==================== RENDER FUNCTIONS ====================
    function showScreen(screenId) {
        document.querySelectorAll('.screen-container > .screen').forEach(s => s.classList.remove('active'));
        if (screenId === 'login') {
            document.getElementById('login-screen').classList.add('active');
            document.getElementById('bottom-nav').style.display = 'none';
        } else {
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById(screenId + '-screen').classList.add('active');
            document.getElementById('bottom-nav').style.display = 'flex';
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.screen === screenId) item.classList.add('active');
                else item.classList.remove('active');
            });
        }
    }

    function updateDashboard() {
        document.getElementById('user-name').innerText = currentUser?.name || 'Inspector';
        const recent = inspections.slice(-3).reverse();
        const list = document.getElementById('recent-list');
        list.innerHTML = recent.length ? recent.map(i => `<li><i class="fas fa-home" style="color:#FFD700;"></i> ${i.propertyAddress || 'Unknown'} ‚Äì ${new Date(i.createdAt).toLocaleDateString()}</li>`).join('') : '<li>No inspections yet</li>';
        document.getElementById('month-count').innerText = inspections.filter(i => new Date(i.createdAt).getMonth() === new Date().getMonth()).length;
    }

    function updateReportsList() {
        const container = document.getElementById('reports-list');
        if (inspections.length === 0) {
            container.innerHTML = '<p class="card">No saved reports.</p>';
            return;
        }
        container.innerHTML = inspections.map((insp, index) => `
            <div class="card" style="padding:12px;">
                <div style="display:flex; justify-content:space-between;">
                    <span><i class="fas fa-map-pin"></i> ${insp.propertyAddress || 'N/A'}</span>
                    <span>${new Date(insp.createdAt).toLocaleDateString()}</span>
                </div>
                <p>${insp.propertyType || 'House'}, ${insp.size || '?'} sq ft ¬∑ Protocol count: ${insp.ratings?.length || 0}</p>
                <button class="btn btn-secondary view-report-btn" data-index="${index}" style="padding:6px; font-size:0.9rem;">View PDF</button>
                <button class="btn delete-report-btn" data-index="${index}" style="padding:6px; background:#b22222;">Delete</button>
            </div>
        `).join('');
        document.querySelectorAll('.view-report-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = e.target.dataset.index;
                generatePDF(inspections[idx], true);
            });
        });
        document.querySelectorAll('.delete-report-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = e.target.dataset.index;
                inspections.splice(idx, 1);
                saveLocalData();
                updateReportsList();
                updateDashboard();
            });
        });
    }

    function updateProfile() {
        document.getElementById('profile-email').innerText = currentUser?.email || '';
        document.getElementById('sub-tier').innerText = currentUser?.tier === 'pro' ? 'Pro' : 'Freemium (3 protocols)';
    }

    function populateProtocolSelect() {
        const select = document.getElementById('inspection-protocol');
        select.innerHTML = '';
        protocols.forEach(p => {
            const option = document.createElement('option');
            option.value = p.id;
            option.textContent = `${p.name} (${p.tier})`;
            select.appendChild(option);
        });
        renderRatingSection(parseInt(select.value));
    }

    function renderRatingSection(protocolId) {
        const protocol = protocols.find(p => p.id === protocolId);
        if (!protocol || !protocol.dimensions) return;
        const container = document.getElementById('rating-section');
        let html = '<h4>Rate Assessment Items (0-10)</h4>';
        protocol.dimensions.forEach((dim, dimIdx) => {
            html += `<div class="dimension-rating"><strong>${dim.name}</strong>`;
            if (dim.items && dim.items.length) {
                dim.items.forEach((item, itemIdx) => {
                    const itemId = `rating_${dimIdx}_${itemIdx}`;
                    html += `<div class="rating-item" id="item-${dimIdx}-${itemIdx}">`;
                    html += `<div class="rating-item-header"><span>${item}</span> <input type="number" min="0" max="10" step="1" value="5" id="${itemId}"></div>`;
                    // Photo area for this item
                    html += `<div class="item-photos" id="photo-area-${dimIdx}-${itemIdx}">`;
                    html += `<div class="photo-grid" id="photo-grid-${dimIdx}-${itemIdx}"></div>`;
                    html += `<button class="add-photo-btn" data-dim="${dimIdx}" data-item="${itemIdx}"><i class="fas fa-camera"></i> Add Photos (max 3)</button>`;
                    html += `</div>`;
                    html += `</div>`;
                });
            } else {
                html += '<p>No items defined.</p>';
            }
            html += '</div>';
        });
        container.innerHTML = html;

        // Attach event listeners to "Add Photos" buttons
        document.querySelectorAll('.add-photo-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const dimIdx = e.target.dataset.dim;
                const itemIdx = e.target.dataset.item;
                // Create a hidden file input
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.multiple = true;
                input.onchange = (event) => handleItemPhotoSelect(event, dimIdx, itemIdx);
                input.click();
            });
        });
    }

    function handleItemPhotoSelect(event, dimIdx, itemIdx) {
        const files = Array.from(event.target.files);
        const key = `${dimIdx}_${itemIdx}`;
        if (!currentItemPhotos[key]) currentItemPhotos[key] = [];
        // Limit to 3 photos per item
        const remainingSlots = 3 - currentItemPhotos[key].length;
        const filesToAdd = files.slice(0, remainingSlots);
        filesToAdd.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const photoObj = {
                    dataURL: e.target.result,
                    annotatedDataURL: null,
                    file
                };
                currentItemPhotos[key].push(photoObj);
                renderItemPhotos(dimIdx, itemIdx);
            };
            reader.readAsDataURL(file);
        });
    }

    function renderItemPhotos(dimIdx, itemIdx) {
        const key = `${dimIdx}_${itemIdx}`;
        const photos = currentItemPhotos[key] || [];
        const grid = document.getElementById(`photo-grid-${dimIdx}-${itemIdx}`);
        if (!grid) return;
        grid.innerHTML = '';
        photos.forEach((photo, idx) => {
            const container = document.createElement('div');
            container.className = 'photo-thumb-container';
            container.innerHTML = `<img src="${photo.annotatedDataURL || photo.dataURL}" class="photo-thumb"><div class="annotate-btn" data-dim="${dimIdx}" data-item="${itemIdx}" data-photo="${idx}">Annotate</div>`;
            grid.appendChild(container);
        });
        // Attach annotate buttons
        grid.querySelectorAll('.annotate-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const d = e.target.dataset.dim;
                const i = e.target.dataset.item;
                const p = e.target.dataset.photo;
                annotatePhoto(d, i, p);
            });
        });
    }

    // Annotation modal logic (simplified ‚Äì same canvas as before, but we'll store per photo)
    let currentAnnotation = { dimIdx: null, itemIdx: null, photoIdx: null };
    function annotatePhoto(dimIdx, itemIdx, photoIdx) {
        currentAnnotation = { dimIdx, itemIdx, photoIdx };
        const key = `${dimIdx}_${itemIdx}`;
        const photo = currentItemPhotos[key][photoIdx];
        // Load image into canvas (code from previous version)
        // For brevity, assume we have a global canvas setup. We'll reuse the same modal.
        // We'll show the annotation modal and after save update the photo's annotatedDataURL.
        const canvas = document.getElementById('annotation-canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            // Also store original image for later saving
        };
        img.src = photo.dataURL;
        document.getElementById('annotation-modal').classList.add('show');
    }

    // Save annotation from canvas (called by "Save" button in annotation modal)
    document.getElementById('tool-save').addEventListener('click', () => {
        const canvas = document.getElementById('annotation-canvas');
        const annotatedDataURL = canvas.toDataURL('image/jpeg');
        const { dimIdx, itemIdx, photoIdx } = currentAnnotation;
        if (dimIdx !== null) {
            const key = `${dimIdx}_${itemIdx}`;
            if (currentItemPhotos[key] && currentItemPhotos[key][photoIdx]) {
                currentItemPhotos[key][photoIdx].annotatedDataURL = annotatedDataURL;
                renderItemPhotos(dimIdx, itemIdx);
            }
        }
        document.getElementById('annotation-modal').classList.remove('show');
    });

    document.getElementById('tool-cancel').addEventListener('click', () => {
        document.getElementById('annotation-modal').classList.remove('show');
    });

    // Basic canvas drawing tools (simplified ‚Äì same as before)
    // ... (for brevity, you can reuse the drawing logic from the previous version)

    function collectRatingsAndPhotos() {
        const ratings = [];
        const photosByItem = {};
        // Iterate over all rating inputs
        document.querySelectorAll('#rating-section input[type="number"]').forEach(input => {
            ratings.push(parseInt(input.value) || 5);
        });
        // Collect photos per item key
        return { ratings, photosByItem: currentItemPhotos };
    }

    function generatePDF(inspectionData, download = true) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(11, 28, 63);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 215, 0);
        doc.setFontSize(16);
        doc.text('PIPS Pro‚Ñ¢', 105, 15, { align: 'center' });
        doc.setFontSize(10);
        doc.setTextColor(255,255,255);
        doc.text('Property Inspection Profit System', 105, 22, { align: 'center' });
        doc.setTextColor(0,0,0);
        doc.setFontSize(14);
        doc.text('Inspection Report', 20, 40);
        doc.setFontSize(11);
        doc.text(`Address: ${inspectionData.propertyAddress || 'N/A'}`, 20, 50);
        doc.text(`Type: ${inspectionData.propertyType || 'House'} | Size: ${inspectionData.size || '?'} sq ft | Age: ${inspectionData.age || '?'} years`, 20, 60);
        doc.text(`Date: ${new Date(inspectionData.createdAt).toLocaleDateString()}`, 20, 80);
        doc.text('Assessment Ratings:', 20, 100);
        if (inspectionData.ratings && inspectionData.ratings.length) {
            let y = 110;
            inspectionData.ratings.forEach((r, i) => {
                doc.text(`Item ${i+1}: ${r}/10`, 20, y);
                y += 7;
            });
        } else {
            doc.text('No ratings provided.', 20, 110);
        }
        doc.text('Photos captured per item.', 20, 200);
        doc.text('¬© Property Inspection Profit System‚Ñ¢ ¬∑ By Ali Sekhr', 105, 280, { align: 'center' });
        if (download) doc.save(`inspection_${Date.now()}.pdf`);
    }

    // ==================== EVENT LISTENERS ====================
    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        currentUser = { id: 1, email, name: email.split('@')[0], tier: 'freemium' };
        localStorage.setItem(STORAGE_USER, JSON.stringify(currentUser));
        showScreen('dashboard');
        updateDashboard();
        updateReportsList();
        updateProfile();
        populateProtocolSelect();
    });

    document.getElementById('register-btn').addEventListener('click', async () => {
        // same as login
        document.getElementById('login-btn').click();
    });

    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const screen = item.dataset.screen;
            showScreen(screen);
            if (screen === 'protocols') { /* update protocols list */ }
            if (screen === 'reports') updateReportsList();
            if (screen === 'profile') updateProfile();
            if (screen === 'new-inspection') { populateProtocolSelect(); currentItemPhotos = {}; }
        });
    });

    document.getElementById('quick-new').addEventListener('click', () => showScreen('new-inspection'));
    document.getElementById('quick-reports').addEventListener('click', () => showScreen('reports'));
    document.getElementById('logout-btn').addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem(STORAGE_USER);
        showScreen('login');
    });

    document.getElementById('generate-report-btn').addEventListener('click', async () => {
        const address = document.getElementById('prop-address').value;
        const type = document.getElementById('prop-type').value;
        const size = document.getElementById('prop-size').value;
        const age = document.getElementById('prop-age').value;
        const protocolId = parseInt(document.getElementById('inspection-protocol').value);
        const protocol = protocols.find(p => p.id === protocolId);
        if (!protocol.free) {
            alert('This protocol is locked. Upgrade to Pro.');
            return;
        }
        const { ratings, photosByItem } = collectRatingsAndPhotos();
        const newAssessment = {
            id: inspections.length + 1,
            propertyAddress: address,
            propertyType: type,
            size,
            age,
            protocolId,
            protocolName: protocol.name,
            ratings,
            photosByItem,
            createdAt: new Date().toISOString(),
            userId: currentUser.id
        };
        inspections.push(newAssessment);
        saveLocalData();
        generatePDF(newAssessment, true);
        updateDashboard();
        updateReportsList();
        // Clear form
        document.getElementById('prop-address').value = '';
        document.getElementById('photo-preview')?.remove(); // not needed
        document.getElementById('rating-section').innerHTML = '';
        currentItemPhotos = {};
        alert('Inspection saved and PDF generated.');
    });

    // Upgrade modal
    const upgradeModal = document.getElementById('upgrade-modal');
    document.getElementById('modal-close').addEventListener('click', () => upgradeModal.classList.remove('show'));
    document.getElementById('modal-upgrade').addEventListener('click', () => {
        alert('Upgrade coming soon!');
        upgradeModal.classList.remove('show');
    });

    window.showPurchaseModal = () => upgradeModal.classList.add('show');

    // Initialize
    if (currentUser) {
        showScreen('dashboard');
        updateDashboard();
        updateReportsList();
        updateProfile();
        populateProtocolSelect();
    } else {
        showScreen('login');
    }
})();
</script>
<!-- Footer links -->
<div style="text-align: center; padding: 10px; font-size: 0.8rem; background: rgba(255,255,255,0.5); margin-top: 10px;">
    <a href="/privacy.html" style="color: #0B1C3F; margin: 0 10px; text-decoration: none;">Privacy Policy</a> |
    <a href="/terms.html" style="color: #0B1C3F; margin: 0 10px; text-decoration: none;">Terms of Service</a> |
    <a href="/refund.html" style="color: #0B1C3F; margin: 0 10px; text-decoration: none;">Refund Policy</a>
    <p style="margin-top: 5px; color: #666;">¬© 2026 Property Inspection Profit System‚Ñ¢ ¬∑ By Ali Sekhr</p>
</div>
</body>
</html>
